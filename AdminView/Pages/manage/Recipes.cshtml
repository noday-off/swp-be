@page
@model AdminView.Pages.manage.RecipesModel
@{
}

<!-- Authentication check-->
<script>
    if(!localStorage.getItem('token')){
        window.location.href = '/login';
    }
</script>

<div class="container">
    <!-- ADD MODAL -->
        <div class="modal fade overflow-auto" id="addModal" data-backdrop="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Create user</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                <!-- Class basic information-->
                <div id="basicInfoSection">
                  <h4>Basic Information</h4>
                  <form id="addForm">
                    <div class="form-group">
                      <label for="AuthorId">Author Id</label>
                      <input type="number" class="form-control" id="AuthorId" name="authorId" required>
                    </div>
                    <div class="form-group">
                      <label for="Title">Title</label>
                      <input type="text" class="form-control" id="Title" name="title" required>
                    </div>
                    <div class="form-group">
                      <label for="Description">Description</label>
                      <textarea class="form-control" id="Description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="Instructions">Instructions</label>
                      <textarea class="form-control" id="Instructions" name="instructions" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="PreserveAdvice">Preserve Advice</label>
                      <textarea class="form-control" id="PreserveAdvice" name="preserveAdvice" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="Image">Images</label>
                      <textarea class="form-control" id="Image" name="image" rows="3"></textarea>
                    </div>

                    <button type="submit" class="mt-3 btn btn-outline-primary">Add</button>
                  </form>
                </div>
                <hr style="border-top: 3px dashed #999999;">
              </div>
            </div>
        </div>
        </div>

    <!--Update modal-->
    <div class="modal fade overflow-auto" id="updateModal" data-backdrop="false">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Modal header-->
              <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <!-- Modal body-->
              <div class="modal-body">
                <!-- Class basic information-->
                <div id="basicInfoSection">
                  <h4>Basic Information</h4>
                  <form id="updateForm">
                   <div class="form-group">
                      <label for="uId">Id</label>
                      <input type="text" class="form-control" id="uId" name="id" readonly>
                    </div>
                    <div class="form-group">
                      <label for="uAuthorId">Author Id</label>
                      <input type="number" class="form-control" id="uAuthorId" name="authorId" required>
                    </div>
                    <div class="form-group">
                      <label for="uTitle">Title</label>
                      <input type="text" class="form-control" id="uTitle" name="title" required>
                    </div>
                    <div class="form-group">
                      <label for="uDescription">Description</label>
                      <textarea class="form-control" id="uDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="uInstructions">Instructions</label>
                      <textarea class="form-control" id="uInstructions" name="instructions" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="uPreserveAdvice">Preserve Advice</label>
                      <textarea class="form-control" id="uPreserveAdvice" name="preserveAdvice" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="uImage">Images</label>
                      <textarea class="form-control" id="uImage" name="image" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                      <label for="uIngredients">Ingredients</label>
                      <input type="text" class="form-control" id="uIngredients" disabled>
                    </div>
                    @*<div class="form-group">
                      <label for="uRole">Role</label>
                        <select id="uRole" name="role" class="form-group">
                            <option value="0">Admin</option>
                            <option value="1">User</option>
                        </select >
                    </div>*@
                    <button type="submit" class="mt-3 btn btn-outline-primary">Update Info</button>
                  </form>
                </div>
                <hr style="border-top: 3px dashed #999999;">
                <!--Update ingredients-->
               @* <h4>Basic Information</h4>
                  <form id="updateForm">
                   <div class="form-group">
                      <input type="text" class="form-control" id="uId" name="id" hidden>
                    </div>
                    <button type="submit" class="mt-3 btn btn-outline-primary">Update Info</button>
                  </form>
              <hr style="border-top: 3px dashed #999999;">*@
              <!--Packages-->
              <div id="packageSection">
                  <h4>Pakages</h4>
                  <details>
                  <summary>Add new package</summary>
                  <form id="addPackageForm">
                    <div class="form-group">
                      <label for="uAuthorId">Recipe Id</label>
                      <input type="number" class="form-control" id="packageRecipeId" name="recipeId" readonly>
                    </div>
                    <div class="form-group">
                      <label for="title">Title</label>
                      <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="form-group">
                      <label for="detail">Details</label>
                      <textarea class="form-control" name="detail" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="nutritionFacts">Nutrition Facts</label>
                      <input type="text" class="form-control" name="nutritionFacts" required>
                    </div>
                    <div class="form-group">
                      <label for="price">Price per package</label>
                      <input type="number" min="0" max="10000000" value="0" class="form-control" name="price" required>
                    </div>
                    <div class="form-group">
                      <label for="quantity">Quantity in-stock</label>
                      <input type="number" min="0" max="100000" value="0" class="form-control" name="quantity" required>
                    </div>
                    <div class="form-group">
                      <label for="sales">Sales</label>
                      <input type="number" min="0" max="10000000" value="0" class="form-control" name="sales" required>
                    </div>
                    <button type="submit" class="mt-3 btn btn-outline-primary">Add Package</button>
                  </form>
                </details>
                  
               @* <div class="table-data__tool-right">
                    <button id="addPackageBtn" class="btn btn-primary">
                        <i class="zmdi zmdi-plus"></i>Create
                    </button>
                </div>*@
                  <table id="packageTable" class="table table-striped table-bordered mt-3">
                  <thead class="thead-dark">
                    <tr>
                      <th>Id</th>
                      <th>Title</th>
                      <th>Detail</th>
                      <th>Nutrition Facts</th>
                      <th>Price</th>
                      <th>Quantity</th>
                      <th>Sales</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="packages"></tbody>
                </table>
              </div>
                </div>
            </div>
          </div>
        </div>

    <h1>List of Recipes</h1>
    <div class="table-data__tool-right">
        <button id="addBtn" class="btn btn-primary">
            <i class="zmdi zmdi-plus"></i>Create
        </button>
    </div>
    @*<input type="text" id="searchBar" placeholder="Search">*@

    <table id="mainTable" class="table table-striped table-bordered mt-3">
    <thead class="thead-dark">
        <tr>
            <th>Id</th>
            <th>Author Id</th>
            <th>Title</th>
            <th>Actions</th>
        </tr>
    </thead>
        <tbody id="items">
            @*<tr>
            <td>
                <div class="table-data-feature">
                    <button class="item edit-order-btn btn btn-outline-secondary" onclick="openUpdateModal(1)" data-order-id="1" data-placement="top" title="Edit"><i class="bi bi-pen-fill"></i></button>
                </div>
            </td>
            </tr>*@
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function () {
        //$('#searchBar').on('keyup', function () {
        //    var searchText = $(this).val();

        //    $.ajax({
        //        url: '/Entities/Search',
        //        type: 'GET',
        //        data: { searchText: searchText },
        //        success: function (result) {
        //            $('#entityTable').html(result);
        //        }
        //    });
        //});

        $.ajax({
            url: '@apiDomain.Url/recipes',
            type: 'GET',
            headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            success: function (data) {
                var tableHTML = $('#items').html();;
                data.forEach(function(item, index) {
                    // populate data 
                    tableHTML += '<tr>';
                    tableHTML += '<td>' + item.id + '</td>';
                    tableHTML += '<td>' + item.authorId + '</td>';
                    tableHTML += '<td>' + item.title + '</td>';
                    tableHTML += '<td>' +
                        '<div class="table-data-feature"><button onclick="openUpdateModal('+item.id+')" class="item edit-order-btn btn btn-outline-secondary" data-order-id="'+ item.id +'" data-placement="top" title="Edit"><i class="bi bi-pen-fill"></i></button></div>'
                        + '</td>';
                    tableHTML += '</tr>';
                });
                $('#items').html(tableHTML);
            },
            error: function(xhr, status, error) {
                // Handle the login error
                var errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Something went wrong!';
                $('.error-message').text(errorMessage);
                alert(errorMessage);
            }
        });
        $('#addBtn').on('click', function(event) {
          event.preventDefault();
          $('#addModal').modal('show');
        });

        $('#addForm').on('submit', function(event) {
          event.preventDefault();
          var formData = $(this).serializeArray();
          add(formData);
        });

        $('#updateForm').on('submit', function(event) {
          event.preventDefault();
          var formData = $(this).serializeArray();
          var id = $('input[name="id"]').val();
          updateBasicInfo(formData,id);
        }); 

        $('#addPackageForm').on('submit', function(event) {
          event.preventDefault();
          var formData = $(this).serializeArray();
          addPackage(formData);
        });

    });

        function openUpdateModal(Id) {
            $.ajax({
                    url: '@apiDomain.Url/recipes/'+Id,
                    method: 'GET',
                    dataType: 'json',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    success: function(data) {
                        // Populate basic information section
                        $('#uId').val(data.id);
                        $('#packageRecipeId').val(data.id);
                        $('#uAuthorId').val(data.authorId);         
                        $('#uTitle').val(data.title);
                        $('#uDescription').val(data.description);
                        $('#uInstructions').val(data.instructions);
                        $('#uPreserveAdvice').val(data.preserveAdvice);
                        $('#uImage').val(data.image);   
                        var ingredients = data.ingredients.join(',');
                        $('#uIngredients').val(ingredients);                  
                        

                        //Populate schedule list
                        var tableHTML = '';
                        data.packages.forEach(function(item, index) {
                            //format date
                            tableHTML += '<tr>';
                            tableHTML += '<td>' + item.id + '</td>';
                            tableHTML += '<td>' + item.title + '</td>';
                            tableHTML += '<td>' + item.detail + '</td>';
                            tableHTML += '<td>' + item.nutritionFacts + '</td>';
                            tableHTML += '<td>' + item.price + '</td>';
                            tableHTML += '<td>' + item.quantity + '</td>';
                            tableHTML += '<td>' + item.sales + '</td>';
                            tableHTML += '<td>' + item.sales + '</td>';
                            tableHTML += '<td>' +
                                '<div class="table-data-feature"><button onclick="deletePackage('+item.id+')" class="item delete-package-btn btn btn-outline-secondary" data-order-id="'+ item.id +'" data-placement="top" title="Edit"><i class="bi bi-trash-fill"></i></button></div>'
                            + '</td>';
                            tableHTML += '</tr>';
                        });
                        $('#packages').html(tableHTML);


                        $('#updateModal').modal('show');
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log('Error fetching class data:', errorThrown);
                        alert("Fail to get the detail.");
                    }
            });
        }

        function add(formData) {
            var formDataJSON = {};
            $.each(formData, function() {
                formDataJSON[this.name] = this.value;
            });
            $.ajax({
              url: '@apiDomain.Url/recipes',
              method: 'POST',
              headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              data: JSON.stringify(formDataJSON),
              contentType: 'application/json',
              success: function(response) {
                console.log('Added successfully');
                location.reload();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.log('Error updating info:', errorThrown);
                alert(jqXHR.responseText || 'Fail to add!');
              }
            });
          }

        function updateBasicInfo(formData,id) {
            var formDataJSON = {};
            $.each(formData, function() {
                formDataJSON[this.name] = this.value;
            });
            $.ajax({
              url: '@apiDomain.Url/recipes/'+ id,
              method: 'PUT',
              headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              data: JSON.stringify(formDataJSON),
              contentType: 'application/json',
              success: function(response) {
                console.log('Updated successfully');
                location.reload();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.log('Error updating info:', errorThrown);
                alert(jqXHR.responseText || 'Fail to update!');
              }
            });
          }

          function addPackage(formData) {
            $('#updateModal').modal('hide');
            var formDataJSON = {};
            $.each(formData, function() {
                formDataJSON[this.name] = this.value;
            });
            $.ajax({
              url: '@apiDomain.Url/packages',
              method: 'POST',
              headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              data: JSON.stringify(formDataJSON),
              contentType: 'application/json',
              success: function(response) {
                console.log('Added successfully');
                //location.reload();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.log('Error updating info:', errorThrown);
                alert(jqXHR.responseText || 'Fail to add!');
              }
            });
            $('#updateModal').modal('show');
          }

          function deletePackage(id) {
            $('#updateModal').modal('hide');
            $.ajax({
              url: '@apiDomain.Url/packages/'+id,
              method: 'DELETE',
              headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              contentType: 'application/json',
              success: function(response) {
                console.log('Deleted successfully');
                //location.reload();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.log('Error updating info:', errorThrown);
                alert(jqXHR.responseText || 'Fail to delete!');
              }
            });
            $('#updateModal').modal('show');
          }
    
</script>
